<h1 class="d-flex justify-content-between align-items-center m-4">
  <span id="playlist-name"><%= @playlist.name %></span>
  <% unless [Playlist::LIKE_PLAYLIST_NAME, Playlist::DISLIKE_PLAYLIST_NAME].include?(@playlist.name) %>
    <button id="rename-button" class="btn btn-link" style="color: var(--bs-primary);">Renommer la playlist</button>
  <% end %>
</h1>

<% unless [Playlist::LIKE_PLAYLIST_NAME, Playlist::DISLIKE_PLAYLIST_NAME].include?(@playlist.name) %>
  <%= form_with(model: @playlist, url: rename_playlist_path(@playlist), method: :patch, id: "rename-form", class: "d-none") do |form| %>
    <div class="input-group mb-3">
      <%= form.text_field :name, class: "form-control", id: "playlist-name-input" %>
      <div class="input-group-append">
        <%= form.submit "Enregistrer", class: "btn btn-primary btn-aurora-glow" %>
        <button type="button" id="cancel-rename" class="btn btn-secondary btn-aurora-glow">Annuler</button>
      </div>
    </div>
  <% end %>
<% end %>

<% is_special_playlist = [Playlist::LIKE_PLAYLIST_NAME, Playlist::DISLIKE_PLAYLIST_NAME].include?(@playlist.name) %>

<% unless is_special_playlist %>
  <div class="bulk-actions mt-3 mb-3 d-flex">
    <%= button_to "J'aime toutes les chansons", like_all_songs_playlist_items_path(playlist_id: @playlist.id), method: :post, class: "btn-aurora-like me-2" %>
    <%= button_to "J'aime aucune des chansons", dislike_all_songs_playlist_items_path(playlist_id: @playlist.id), method: :post, class: "btn-aurora-dislike" %>
  </div>
<% end %>

<div class="playlist-container">
  <% @playlist_items.each do |playlist_item| %>
    <% track = playlist_item.track %>
    <div class="song-item d-flex justify-content-between align-items-center p-3 border-bottom">

      <div class="song-cover me-3">
        <% if track.cover_url.present? %>
          <%= image_tag(track.cover_url, alt: "#{track.title} cover", class: "img-thumbnail", style: "width: 100px; height: 100px; object-fit: cover;") %>
        <% else %>
          <div class="no-cover" style="width: 100px; height: 100px; background: #ccc; display: flex; align-items: center; justify-content: center;">
            <span>Pas de pochette</span>
          </div>
        <% end %>
      </div>

      <div class="song-info flex-grow-1">
        <p class="mb-1"><strong><%= track.title %></strong> par <em><%= track.artist_name %></em></p>

        <% if playlist_item.description.present? %>
          <p class="text-muted fst-italic mb-2">
            → <%= playlist_item.description %>
          </p>
        <% end %>
        <p class="mb-2 small">Durée : <%= (track.duration / 1000).to_i %> secondes</p>

        <% if track.preview_url.present? %>
          <div class="audio-player">
            <audio controls preload="none" style="width: 100%;">
              <source src="<%= track.preview_url %>" type="audio/mpeg" />
              Votre navigateur ne supporte pas l'élément audio.
            </audio>
          </div>
        <% end %>
      </div>

      <div class="song-actions d-flex flex-column ms-3">
        <% unless is_special_playlist %>
          <%= button_to "J'aime", like_playlist_item_path(playlist_item), method: :post, class: "btn-aurora-like mb-1" %>
          <%= button_to "J'aime pas", dislike_playlist_item_path(playlist_item), method: :post, class: "btn-aurora-dislike mb-1" %>
        <% end %>
        <%= button_to "Supprimer", playlist_item_path(playlist_item), method: :delete, class: "btn-aurora-delete" %>
      </div>
    </div>
  <% end %>
</div>

<div class="mt-4 d-flex justify-content-start">
  <%= link_to "Générer une nouvelle playlist", new_playlist_path, class: "btn btn-primary btn-aurora-glow me-2" %>
  <%= link_to "Retour aux playlists", playlists_path, class: "btn btn-secondary btn-aurora-glow" %>
</div>

<%= render "shared/bottom_navbar" %>

<script>
  document.addEventListener('turbo:load', () => {
    const renameButton = document.getElementById('rename-button')
    const renameForm = document.getElementById('rename-form')
    const playlistNameSpan = document.getElementById('playlist-name')
    const cancelRenameButton = document.getElementById('cancel-rename')

    if (renameButton && renameForm && playlistNameSpan && cancelRenameButton) {
      renameButton.addEventListener('click', () => {
        renameForm.classList.remove('d-none')
        playlistNameSpan.classList.add('d-none')
        renameButton.classList.add('d-none')
      })

      cancelRenameButton.addEventListener('click', () => {
        renameForm.classList.add('d-none')
        playlistNameSpan.classList.remove('d-none')
        renameButton.classList.remove('d-none')
      })
    }
  })
</script>
